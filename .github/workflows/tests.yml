name: CI Completa - San Felipe Inmobiliaria

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ======================================================
  # JOB 1: VALIDACIÃ“N DEL BACKEND (Express + TypeScript)
  # ======================================================
  backend_ci:
    name: Backend - Pruebas y Tipado (API)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js (VersiÃ³n 18+)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš™ï¸ Instalar dependencias del Backend
        run: cd Backend-Inmobiliaria && npm install
        
      - name: ğŸ•µï¸â€â™€ï¸ Verificar Tipado (tsc) y Compilar
        run: cd Backend-Inmobiliaria && npm run build
        
      - name: âœ… Ejecutar Pruebas del Backend
        run: cd Backend-Inmobiliaria && npm test
        
      - name: ğŸ§¹ Ejecutar Linter (Opcional, si usas ESLint/TSLint)
        run: cd Backend-Inmobiliaria && npm run lint

  # ======================================================
  # JOB 2: VALIDACIÃ“N DEL FRONTEND (React Native + Expo)
  # El Job rÃ¡pido de pruebas de JS/TS
  # ======================================================
  frontend_ci:
    name: Frontend - Pruebas y Linter (Movil)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš™ï¸ Instalar dependencias del Movil
        run: cd Movil-Inmobiliaria && npm install

      - name: âœ… Ejecutar Pruebas Unitarias del Movil (Jest)
        run: cd Movil-Inmobiliaria && npm test
        
      - name: ğŸ§¹ Ejecutar Linter
        run: cd Movil-Inmobiliaria && npm run lint

      - name: ğŸ•µï¸â€â™€ï¸ Verificar Tipado del Frontend
        run: cd Movil-Inmobiliaria && npx tsc --noEmit

  # ======================================================
  # JOB 3: VERIFICACIÃ“N DE COMPILACIÃ“N ANDROID
  # (Lento, solo se ejecuta si el JS/TS pasÃ³)
  # ======================================================
  android_build_check:
    name: ğŸ“± VerificaciÃ³n de CompilaciÃ³n Android
    runs-on: ubuntu-latest
    # ESTO ES LO CLAVE: Solo se ejecuta si frontend_ci pasÃ³ con Ã©xito.
    needs: [frontend_ci] 

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš™ï¸ Instalar dependencias del Movil (Nuevamente)
        run: cd Movil-Inmobiliaria && npm install
        
      - name: â˜• Configurar Java (para Android)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: ğŸ”¨ Compilar Build de Android con Gradle
        # Esto valida que no haya errores de compilaciÃ³n nativa en Android.
        run: cd Movil-Inmobiliaria/android && ./gradlew assembleDebug